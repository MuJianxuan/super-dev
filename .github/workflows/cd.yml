name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # ========== 部署到开发环境 ==========
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: https://dev.AuthSystem.example.com
    steps:
      - uses: actions/checkout@v3

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${ '{' } secrets.KUBE_CONFIG_DEV {}' }

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/ -n dev
          kubectl rollout restart deployment/AuthSystem -n dev

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/AuthSystem -n dev

  # ========== 部署到生产环境 ==========
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://AuthSystem.example.com
    steps:
      - uses: actions/checkout@v3

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${ '{' } secrets.KUBE_CONFIG_PROD {}' }

      - name: Create backup
        run: |
          kubectl get deployment AuthSystem -n prod -o yaml > backup-{ '{' } github.sha {}' }.yaml

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/ -n prod
          kubectl rollout restart deployment/AuthSystem -n prod

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/AuthSystem -n prod

      - name: Health check
        run: |
          for i in { '{' } {1..30} {}'; do
            if curl -f https://AuthSystem.example.com/health; then
              echo "Health check passed"
              exit 0
            fi
            echo "Waiting for health check... ($i/30)"
            sleep 10
          done
          echo "Health check failed"
          exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          kubectl apply -f backup-{ '{' } github.sha {}' }.yaml
          kubectl rollout undo deployment/AuthSystem -n prod
